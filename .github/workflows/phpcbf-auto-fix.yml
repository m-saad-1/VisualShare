name: PHPCBF Auto-fix

# Run on manual trigger and on push (adjust branches to your needs)
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - 'feature/**'
      - 'fix/**'

permissions:
  contents: write

concurrency:
  group: phpcbf-autofix-${{ github.ref }}
  cancel-in-progress: true

jobs:
  phpcbf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: shivammathur/setup-php@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup PHP
        uses: shivammathur/setup-php@v3
        with:
          php-version: '8.2'
          coverage: none

      - name: Install composer (if missing)
        run: |
          if ! command -v composer >/dev/null 2>&1; then
            EXPECTED_COMPOSER_PHAR=composer.phar
            php -r "copy('https://getcomposer.org/installer','installer.php');"
            php installer.php --install-dir=/usr/local/bin --filename=composer
            php -r "unlink('installer.php');"
          fi
          composer --version

      - name: Install dependencies (or ensure phpcs present)
        run: |
          # Install dependencies if composer.json exists
          if [ -f composer.json ]; then
            composer install --no-interaction --no-progress --prefer-dist
          fi
          # Ensure phpcbf exists; install PHP_CodeSniffer if missing
          if [ ! -x vendor/bin/phpcbf ]; then
            composer require --dev --no-interaction --no-progress squizlabs/php_codesniffer || true
          fi

      - name: Run PHPCBF (auto-fix)
        run: |
          # Choose the standard you use in your repo (PSR12 is common)
          STANDARD=${{ inputs.standard || 'PSR12' }}
          echo "Running phpcbf with standard: ${STANDARD}"
          vendor/bin/phpcbf --standard=${STANDARD} -n .

      - name: Show remaining PHPCS issues (optional)
        run: |
          vendor/bin/phpcs --standard=PSR12 || true

      - name: Commit & push fixes if there are changes
        env:
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          # Prevent infinite loops: exit if last commit was made by GitHub Actions bot
          LAST_AUTHOR="$(git log -1 --pretty='%an' || true)"
          if [ "$LAST_AUTHOR" = "github-actions[bot]" ] || [ "$LAST_AUTHOR" = "github-actions" ]; then
            echo "Last commit by GitHub Actions ($LAST_AUTHOR). Exiting to avoid loop."
            exit 0
          fi

          # Configure git user for the commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only commit if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            # Use a clear commit message and skip CI to avoid re-running workflows if your CI honors [skip ci]
            git commit -m "chore: run phpcbf to fix coding style issues [skip ci]" || echo "Nothing to commit"
            # Push to the current branch. Using persist-credentials: true gives GITHUB_TOKEN auth.
            git push
            echo "Changes pushed."
          else
            echo "No changes after phpcbf."
          fi
